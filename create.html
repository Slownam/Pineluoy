<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Create Panel — LF</title>
<style>
:root{--bg:#020317;--card:#07102a;--neon1:#7c3aed;--neon2:#4f46e5;--text:#eaf4ff}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#030414,#07102a);color:var(--text);min-height:100vh}
.container{max-width:980px;margin:30px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(90deg,var(--neon1),var(--neon2));display:flex;align-items:center;justify-content:center;font-weight:900}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 40px rgba(2,6,23,0.6);margin-top:14px}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);margin-top:8px}
.select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);margin-top:8px}
.btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--neon1),var(--neon2));color:white;font-weight:700;cursor:pointer;margin-top:12px}
.countdown{position:fixed;left:18px;top:18px;background:rgba(6,7,20,0.75);padding:10px 12px;border-radius:10px;border:1px solid rgba(124,58,237,0.18);font-weight:700}
.result{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
.small{font-size:13px;color:#cfe0ff;margin-top:8px}
.footer{margin-top:18px;display:flex;gap:12px;align-items:center}
.bad{color:#ffb4b4}
@media (max-width:820px){ .header{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
  <div class="countdown" id="countdown">Account: —</div>

  <div class="container">
    <div class="header">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="logo">LF</div>
        <div>
          <div style="font-weight:800;font-size:18px">Create Panel</div>
          <div class="small">Buat server Pterodactyl otomatis via API</div>
        </div>
      </div>
      <div>
        <button id="btnBack" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06)">Kembali</button>
      </div>
    </div>

    <div class="card">
      <label>Nama server</label>
      <input id="srvName" class="input" placeholder="nama-server">

      <label>Pilih RAM</label>
      <select id="ram" class="select">
        <option value="1gb">1GB</option><option value="2gb">2GB</option><option value="3gb">3GB</option>
        <option value="4gb">4GB</option><option value="5gb">5GB</option><option value="6gb">6GB</option>
        <option value="7gb">7GB</option><option value="8gb">8GB</option><option value="9gb">9GB</option>
        <option value="10gb">10GB</option><option value="unlimited">Unlimited</option>
      </select>

      <div class="small" style="margin-top:10px">Email & password dibuat otomatis dari nama.</div>
      <div style="display:flex;gap:8px">
        <button id="btnCreate" class="btn">Create Server</button>
        <button id="btnPreview" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06)">Preview</button>
      </div>

      <div class="result" id="result">Hasil: belum ada</div>
      <div class="small" id="specs">Spesifikasi: -</div>

      <div class="footer">
        <div class="small">WA: <a href="https://wa.me/6283150061244" target="_blank" class="small">6283150061244</a></div>
        <div class="small">•</div>
        <div class="small">Telegram: <a href="https://t.me/lfstarstore" target="_blank" class="small">@lfstarstore</a></div>
      </div>
    </div>
  </div>

<script src="settings.js"></script>
<script>
function getApiBase(){
  try{ const c = JSON.parse(localStorage.getItem('panel_api_cfg')||'null'); if(c && c.api_base) return c.api_base; }catch(e){}
  return (window.API_CONFIG && window.API_CONFIG.API_BASE) ? window.API_CONFIG.API_BASE : 'http://127.0.0.1:3000';
}
function getAdminKey(){ return localStorage.getItem('panel_admin_key') || ''; }

// resource map sesuai case yang kamu minta
const resourceMap = {
  "1gb": { ram: "1000", disk: "1000", cpu: "40" },
  "2gb": { ram: "2000", disk: "1000", cpu: "60" },
  "3gb": { ram: "3000", disk: "2000", cpu: "80" },
  "4gb": { ram: "4000", disk: "2000", cpu: "100" },
  "5gb": { ram: "5000", disk: "3000", cpu: "120" },
  "6gb": { ram: "6000", disk: "3000", cpu: "140" },
  "7gb": { ram: "7000", disk: "4000", cpu: "160" },
  "8gb": { ram: "8000", disk: "4000", cpu: "180" },
  "9gb": { ram: "9000", disk: "5000", cpu: "200" },
  "10gb": { ram: "10000", disk: "5000", cpu: "220" },
  "unlimited": { ram: "0", disk: "0", cpu: "0" }
};

function rand3(){ return Math.floor(100 + Math.random()*900).toString(); }
function sanitizeName(n){ return n.toLowerCase().replace(/[^a-z0-9]/g,''); }

function updatePreview(){
  const name = document.getElementById('srvName').value.trim() || 'server';
  const username = sanitizeName(name) + rand3();
  document.getElementById('specs').textContent = 'Email contoh: ' + username + '@gmail.com • Password contoh: ' + username + rand3();
}
document.getElementById('srvName').addEventListener('input', updatePreview);
document.getElementById('ram').addEventListener('change', updatePreview);
updatePreview();

// countdown dari sessionStorage auth_user.expires_at
const authRaw = sessionStorage.getItem('auth_user');
let AUTH = null;
if(authRaw){ try{ AUTH = JSON.parse(authRaw); }catch(e){ AUTH = null; } }
function startCountdown(exp){
  const el = document.getElementById('countdown');
  if(!exp){ el.textContent = 'Account: -'; return; }
  const target = new Date(exp).getTime();
  const fn = ()=>{
    const now = Date.now();
    let d = target - now;
    if(d <= 0){ el.textContent = 'Account: Kadaluarsa'; clearInterval(iv); return; }
    const days = Math.floor(d/86400000); d%=86400000;
    const hrs = Math.floor(d/3600000); d%=3600000;
    const mins = Math.floor(d/60000); d%=60000;
    const secs = Math.floor(d/1000);
    el.textContent = `Sisa: ${days}d ${hrs}j ${mins}m ${secs}d`;
  };
  fn();
  const iv = setInterval(fn,1000);
}
if(AUTH && AUTH.expires_at) startCountdown(AUTH.expires_at);

// create server
async function apiCreate(payload){
  const base = getApiBase();
  const key = getAdminKey();
  if(!key) throw new Error('ADMIN_KEY belum disimpan (Admin Panel)');
  const res = await fetch(base + '/api/create-server', {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'x-api-key': key },
    body: JSON.stringify(payload)
  });
  let j;
  try{ j = await res.json(); } catch(e){ throw new Error('Ptero API tidak merespon JSON'); }
  if(!j.ok) throw new Error(j.error || JSON.stringify(j));
  return j.data || j;
}

document.getElementById('btnCreate').addEventListener('click', async ()=>{
  const name = document.getElementById('srvName').value.trim();
  if(!name) return alert('Isi nama server');
  const ramKey = document.getElementById('ram').value;
  const spec = resourceMap[ramKey] || resourceMap['1gb'];
  // user id from auth
  const user = (AUTH && AUTH.id) ? AUTH.id : null;
  const payload = {
    name,
    user: user || sanitizeName(name) + rand3(), // backend will accept email or id; ideal: send id
    egg: (window.API_CONFIG && window.API_CONFIG.EGG) ? window.API_CONFIG.EGG : 15,
    docker_image: 'ghcr.io/parkervcp/yolks:nodejs_20',
    startup: '',
    limits: { memory: Number(spec.ram), swap: 0, disk: Number(spec.disk), io: 500, cpu: Number(spec.cpu) }
  };

  const rbox = document.getElementById('result');
  rbox.innerHTML = 'Membuat server...';
  try{
    const data = await apiCreate(payload);
    // tampilkan ringkasan yang rapi, bukan "status:true"
    let out = '<strong>Berhasil membuat server</strong><br/>';
    if(data && data.attributes && data.attributes.id) out += `Server ID: ${data.attributes.id}<br/>`;
    if(data && data.attributes && data.attributes.name) out += `Name: ${data.attributes.name}<br/>`;
    out += `<pre style="white-space:pre-wrap;max-height:260px;overflow:auto;margin-top:8px">${JSON.stringify(data, null, 2)}</pre>`;
    rbox.innerHTML = out;
  }catch(err){
    console.error(err);
    rbox.innerHTML = `<span class="bad">Error: ${err.message}</span>`;
  }
});

document.getElementById('btnPreview').addEventListener('click', updatePreview);
document.getElementById('btnBack').addEventListener('click', ()=> location.href='index.html');
</script>
</body>
</html>