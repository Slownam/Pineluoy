<!Doctype html>
<html lang="id">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Create Server — Panel (after login)</title>
<style>
  body{font-family:Inter,Arial,system-ui;background:#f7fafc;padding:24px;color:#0f172a}
  .card{background:white;border-radius:12px;padding:18px;max-width:820px;margin:0 auto;box-shadow:0 6px 20px rgba(2,6,23,0.08)}
  label{font-weight:700}
  input,select,textarea,button{width:100%;padding:8px;margin:6px 0;border:1px solid #e2e8f0;border-radius:8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{background:#2563eb;color:white;padding:10px;border-radius:8px;border:0;cursor:pointer}
  pre{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto}
</style>
</head>
<body>
  <div class="card">
    <h2>Create Server — (After Login)</h2>
    <div id="who" style="margin-bottom:8px;color:#0f172a"></div>

    <p class="small">Jika belum login, kamu akan diarahkan ke <a href="login.html">Login</a>.</p>

    <form id="form">
      <label>Nama server</label><input id="name" required />

      <div class="row">
        <div><label>Owner user ID</label><input id="user" required /></div>
        <div><label>Allocation ID (primary)</label><input id="alloc" /></div>
      </div>

      <div class="row">
        <div><label>Egg ID</label><input id="egg" /></div>
        <div><label>Nest ID</label><input id="nest" /></div>
      </div>

      <div class="row">
        <div><label>Memory (MB)</label><input id="memory" type="number" value="512" /></div>
        <div><label>Disk (MB)</label><input id="disk" type="number" value="1024" /></div>
      </div>

      <label>Startup Command (optional)</label><input id="startup" placeholder="npm start" />
      <label>Docker image (optional)</label><input id="docker" placeholder="ghcr.io/parkervcp/yolks:nodejs_20" />

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <button id="createBtn" class="btn" type="submit">Buat Server</button>
        <button id="logoutBtn" type="button" style="background:#111827;color:white;padding:10px;border-radius:8px;border:0">Logout</button>
        <div id="status" style="margin-left:8px"></div>
      </div>
    </form>

    <h3 style="margin-top:12px">Response API</h3>
    <pre id="resp">-</pre>
  </div>

<script>
/*
  create.html (WORKING)
  - must be accessed after login (sessionStorage auth_logged_in)
  - loads settings.js from same settings_url stored in localStorage (set by login page)
  - uses window.Domain and window.ptla to call Pterodactyl Application API
*/

function isLogged(){
  return sessionStorage.getItem('auth_logged_in') === '1';
}
if(!isLogged()){
  location.href = 'login.html';
}

const userObj = JSON.parse(sessionStorage.getItem('auth_user') || '{}');
document.getElementById('who').textContent = 'Login sebagai: ' + (userObj.name || userObj.email || userObj.id);

// load settings.js same way as login page (from localStorage.settings_url or local file)
async function loadSettingsIfNeeded(){
  const url = localStorage.getItem('settings_url') || '';
  if(!url){
    // try local settings.js in same folder by dynamic import attempt
    // if that doesn't set window.Domain/ptla, user must set settings_url
    return;
  }
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('fetch settings failed: ' + r.status);
    const txt = await r.text();
    (0,eval)(txt);
  }catch(e){
    console.warn('Load settings failed:', e);
  }
}

function safeGet(name){ try{ return window[name]; }catch(e){return undefined;} }

document.getElementById('egg').value = safeGet('egg') || '';
document.getElementById('nest').value = safeGet('nestid') || '';
document.getElementById('memory').value = safeGet('default_memory') || 512;

loadSettingsIfNeeded().then(()=> {
  document.getElementById('egg').value = safeGet('egg') || document.getElementById('egg').value;
  document.getElementById('nest').value = safeGet('nestid') || document.getElementById('nest').value;
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  sessionStorage.removeItem('auth_logged_in');
  sessionStorage.removeItem('auth_user');
  location.href = 'login.html';
});

async function createServer(payload){
  const Domain = window.Domain || '';
  const ptla = window.ptla || '';
  if(!Domain || !ptla) throw new Error('settings.js belum dimuat atau Domain/ptla belum diset.');
  const res = await fetch(Domain.replace(/\/$/,'') + '/api/application/servers', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'Application/vnd.pterodactyl.v1+json',
      'Authorization': 'Bearer ' + ptla
    },
    body: JSON.stringify(payload)
  });
  return res;
}

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const status = document.getElementById('status');
  const resp = document.getElementById('resp');
  status.textContent = 'Mengirim...';
  resp.textContent = '-';

  try{
    const payload = {
      name: document.getElementById('name').value.trim(),
      user: parseInt(document.getElementById('user').value,10),
      egg: parseInt(document.getElementById('egg').value,10),
      docker_image: document.getElementById('docker').value || undefined,
      startup: document.getElementById('startup').value || undefined,
      environment: {},
      allocation: document.getElementById('alloc').value ? [ parseInt(document.getElementById('alloc').value,10) ] : [],
      limits: {
        memory: parseInt(document.getElementById('memory').value,10) || 512,
        swap: 0,
        disk: parseInt(document.getElementById('disk').value,10) || 1024,
        io: 500,
        cpu: 0
      },
      feature_limits: { databases: 1, backups: 1, allocations: 1 },
      deploy: { locations: (window.loc ? [parseInt(window.loc,10)] : []), dedicated_ip:false, port_range:[] }
    };

    // remove undefined/empty items
    if(!payload.docker_image) delete payload.docker_image;
    if(!payload.startup) delete payload.startup;
    if(payload.allocation && payload.allocation.length === 0) delete payload.allocation;

    const res = await createServer(payload);
    const txt = await res.text();
    try { resp.textContent = JSON.stringify(JSON.parse(txt), null, 2); } catch (err) { resp.textContent = txt; }
    status.textContent = res.ok ? 'Sukses' : 'Gagal (HTTP ' + res.status + ')';
  }catch(err){
    resp.textContent = 'Error: ' + err.message;
    status.textContent = 'Gagal';
  }
});
</script>
</body>
</html>