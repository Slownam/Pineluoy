<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Create Panel â€” after login</title>
<style>
  body{font-family:Inter,Arial,system-ui;background:#f7fafc;padding:20px;color:#0f172a}
  .card{max-width:900px;margin:0 auto;background:white;padding:16px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
  label{font-weight:700}
  input,select,textarea,button{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #e6eef6}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{background:#2563eb;color:white;padding:8px;border-radius:8px;border:0;cursor:pointer}
  pre{background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px}
  .muted{color:#64748b}
</style>
</head>
<body>
  <div class="card">
    <h2>Create Panel (after login)</h2>
    <div id="who" style="margin-bottom:8px"></div>
    <div id="countdown" style="margin-bottom:10px;color:#b91c1c;font-weight:700"></div>

    <form id="form">
      <label>Server name</label><input id="name" required />

      <div class="row">
        <div><label>RAM pilihan</label>
          <select id="ram">
            <option value="1gb">1 GB</option>
            <option value="2gb">2 GB</option>
            <option value="3gb">3 GB</option>
            <option value="4gb">4 GB</option>
            <option value="5gb">5 GB</option>
          </select>
        </div>
        <div><label>Allocation ID (optional)</label><input id="alloc" /></div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button id="createBtn" class="btn" type="submit">Buat Server</button>
        <button id="logoutBtn" type="button" style="background:#111827;color:white;padding:8px;border-radius:8px;border:0">Logout</button>
        <div id="status" style="margin-left:10px" class="muted"></div>
      </div>
    </form>

    <h3 style="margin-top:14px">Response API</h3>
    <pre id="resp">-</pre>
  </div>

<script src="settings.js"></script>
<script>
/*
 create.html (WORKING)
 - requires sessionStorage auth (set by login.html)
 - uses window.Domain & window.ptla from settings.js
 - uses DB config/token from sessionStorage (saved at login)
 - after create server succeeds: append server info to account.servers in database.json and push (PUT) to GitHub
*/

function b64enc(s){ return btoa(unescape(encodeURIComponent(s))); }
function b64dec(b){ try{ return decodeURIComponent(escape(atob(b))); }catch(e){ return atob(b); } }

const API_BASE = 'https://api.github.com/repos';

// protect page
if(sessionStorage.getItem('auth_logged_in') !== '1'){
  alert('Belum login. Arahkan ke halaman login.');
  location.href = 'login.html';
}

const authUser = JSON.parse(sessionStorage.getItem('auth_user') || '{}');
const dbCfg = JSON.parse(sessionStorage.getItem('db_cfg') || '{}');

document.getElementById('who').textContent = `Login sebagai: ${authUser.name || authUser.email} (ID: ${authUser.id})`;

// show countdown if expires_at
function startCountdown(expireIso){
  const el = document.getElementById('countdown');
  if(!expireIso){ el.textContent = ''; return; }
  function update(){
    const diff = Date.parse(expireIso) - Date.now();
    if(diff <= 0){ el.textContent = 'Akun kadaluwarsa'; clearInterval(timer); return; }
    const days = Math.floor(diff / (1000*60*60*24));
    const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
    const mins = Math.floor((diff % (1000*60*60)) / (1000*60));
    const secs = Math.floor((diff % (1000*60)) / 1000);
    el.textContent = `Sisa masa aktif: ${days}d ${hours}h ${mins}m ${secs}s`;
  }
  update();
  const timer = setInterval(update, 1000);
}

startCountdown(authUser.expires_at);

// simple RAM -> limits mapping (example mapping)
const resourceMap = {
  "1gb": { ram: 1000, disk: 1000, cpu: 40 },
  "2gb": { ram: 2000, disk: 1000, cpu: 60 },
  "3gb": { ram: 3000, disk: 2000, cpu: 80 },
  "4gb": { ram: 4000, disk: 2000, cpu: 100 },
  "5gb": { ram: 5000, disk: 3000, cpu: 120 }
};

async function ghGet(owner, repo, path, token){
  const url = `${API_BASE}/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const res = await fetch(url, { headers: { 'Authorization':'token '+token, 'Accept':'application/vnd.github.v3+json' }});
  if(res.status === 404) return null;
  if(!res.ok) throw new Error('GitHub GET error: ' + res.status + ' ' + await res.text());
  return await res.json();
}
async function ghPut(owner, repo, path, contentB64, message, sha, token, branch){
  const url = `${API_BASE}/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: contentB64, branch };
  if(sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers:{ 'Authorization':'token '+token, 'Accept':'application/vnd.github.v3+json', 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  if(!res.ok) throw new Error('GitHub PUT error: ' + res.status + ' ' + await res.text());
  return await res.json();
}

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  sessionStorage.removeItem('auth_logged_in'); sessionStorage.removeItem('auth_user'); sessionStorage.removeItem('db_cfg');
  location.href = 'login.html';
});

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const status = document.getElementById('status');
  const resp = document.getElementById('resp');
  status.textContent = 'Membuat server...'; resp.textContent = '-';
  try{
    // settings.js values
    const Domain = window.Domain || '';
    const ptla = window.ptla || '';
    if(!Domain || !ptla) throw new Error('settings.js: Domain atau ptla belum di-set.');

    // build payload minimal for Pterodactyl
    const name = (document.getElementById('name').value||'').trim();
    const ramKey = document.getElementById('ram').value;
    const alloc = document.getElementById('alloc').value.trim();

    const map = resourceMap[ramKey] || resourceMap['1gb'];

    const payload = {
      name: name,
      user: authUser.id || 1, // owner user ID (should be numeric)
      egg: parseInt(window.egg || '15'),
      docker_image: 'ghcr.io/parkervcp/yolks:nodejs_20',
      startup: '', // leave blank or set default if needed
      environment: {},
      limits: { memory: map.ram, swap: 0, disk: map.disk, io: 500, cpu: map.cpu },
      feature_limits: { databases: 1, backups: 1, allocations: 1 },
      deploy: { locations: [ parseInt(window.loc || '1') ], dedicated_ip: false, port_range: [] }
    };
    if(alloc) payload.deployment = { allocation: parseInt(alloc) };

    // call pterodactyl create
    const r = await fetch(Domain.replace(/\/$/,'') + '/api/application/servers', {
      method: 'POST',
      headers: { 'Accept':'Application/vnd.pterodactyl.v1+json', 'Content-Type':'application/json', 'Authorization':'Bearer ' + ptla },
      body: JSON.stringify(payload)
    });
    const text = await r.text();
    try{ resp.textContent = JSON.stringify(JSON.parse(text), null, 2); }catch(e){ resp.textContent = text; }
    status.textContent = r.ok ? 'Server dibuat' : `Gagal (HTTP ${r.status})`;

    if(r.ok){
      // write server info to database.json
      if(!dbCfg || !dbCfg.token) { console.warn('DB config/token not present in sessionStorage'); return; }
      const file = await ghGet(dbCfg.owner, dbCfg.repo, dbCfg.path, dbCfg.token);
      let db = { codes:[], accounts:[] }; let sha = null;
      if(file){ sha = file.sha; db = JSON.parse(b64dec(file.content.replace(/\n/g,''))); }
      db.accounts = db.accounts || [];

      // find account in db by id (authUser.id)
      const acc = db.accounts.find(a => a.id === authUser.id);
      const serverLog = { created_at: new Date().toISOString(), payload_summary: { name: payload.name, memory: payload.limits.memory, disk: payload.limits.disk } };
      if(acc){
        acc.servers = acc.servers || [];
        acc.servers.push(serverLog);
      } else {
        // fallback: append to accounts (shouldn't happen)
        db.accounts.push({ id: authUser.id || genId(), name: authUser.name, email: authUser.email, wa: authUser.wa, servers: [serverLog], created_at: new Date().toISOString() });
      }

      // push back
      const newContent = b64enc(JSON.stringify(db, null, 2));
      await ghPut(dbCfg.owner, dbCfg.repo, dbCfg.path, newContent, `Add server for ${authUser.id}`, sha, dbCfg.token, dbCfg.branch || 'main');

      // update session user (so countdown persists)
      // fetch latest account to maybe get expires_at
      const updatedFile = await ghGet(dbCfg.owner, dbCfg.repo, dbCfg.path, dbCfg.token);
      if(updatedFile){
        const updatedDB = JSON.parse(b64dec(updatedFile.content.replace(/\n/g,'')));
        const updatedAcc = (updatedDB.accounts||[]).find(a => a.id === authUser.id);
        if(updatedAcc){
          sessionStorage.setItem('auth_user', JSON.stringify(updatedAcc));
          startCountdown(updatedAcc.expires_at);
        }
      }
    }
  }catch(err){
    status.textContent = 'Error: ' + (err.message || err);
    resp.textContent = err.stack || String(err);
    console.error(err);
  }
});
</script>
</body>
</html>