<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Login — Panel</title>
<style>
  body{font-family:Inter,Arial,system-ui;background:linear-gradient(135deg,#6c5ce7,#4f46e5);color:#eef2ff;margin:0;height:100vh;display:flex;align-items:center;justify-content:center}
  .card{background:rgba(255,255,255,0.04);padding:20px;border-radius:12px;max-width:420px;width:92%;box-shadow:0 8px 30px rgba(2,6,23,0.3)}
  h2{margin:0 0 8px}
  label{display:block;margin-top:10px;font-weight:700}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#eef2ff;box-sizing:border-box}
  .btn{margin-top:12px;padding:10px;border-radius:8px;border:0;background:linear-gradient(90deg,#8b5cf6,#5b21b6);color:white;font-weight:700;width:100%}
  .muted{font-size:13px;color:#c7d2fe;margin-top:8px}
  .msg{margin-top:10px;font-size:13px}
  pre{background:#07102a;padding:8px;border-radius:8px;overflow:auto}
</style>
</head>
<body>
  <div class="card">
    <h2>Login</h2>
    <p class="muted">Masukkan Nama, Email, Nomor WA, Tanggal Lahir, dan Kode Akses. Jika valid, langsung diarahkan ke halaman create panel.</p>

    <form id="form">
      <label>Nama</label>
      <input id="name" required />

      <label>Email</label>
      <input id="email" type="email" required />

      <label>Nomor WA (contoh: 6285...)</label>
      <input id="wa" required />

      <label>Tanggal Lahir (YYYY-MM-DD)</label>
      <input id="dob" placeholder="1995-12-31" required />

      <label>Kode Akses</label>
      <input id="code" required placeholder="lfxxxxx" />

      <button class="btn" type="submit">Login</button>
    </form>

    <div id="status" class="msg"></div>
  </div>

<script src="settings.js"></script>
<script>
/*
 WORKING login flow:
 - Uses GitHub REST API to GET database.json from private repo (replace DB_* constants)
 - Checks provided access code exists and unused.
 - If valid: mark code used, add account to db.accounts (with fields requested), PUT back to GitHub.
 - Save auth (sessionStorage) including DB config and token so create.html can write to DB.
 - Redirect to create.html
*/

/* ===== CONFIG: EDIT THESE to match your private DB repo (REQUIRED) =====
   Or replace values programmatically before hosting.
*/
const DB_OWNER = 'YOUR_DB_GITHUB_OWNER';   // e.g. 'myuser' or 'org'
const DB_REPO  = 'YOUR_DB_REPO_NAME';      // repo where database.json lives (private)
const DB_PATH  = 'database.json';          // path in repo
const DB_BRANCH = 'main';                  // branch
const DB_TOKEN = 'ghp_REPLACE_WITH_YOUR_TOKEN'; // token with contents read/write for that repo
/* ==================================================================== */

const API_BASE = 'https://api.github.com/repos';
function b64enc(s){ return btoa(unescape(encodeURIComponent(s))); }
function b64dec(b){ try{ return decodeURIComponent(escape(atob(b))); } catch(e){ return atob(b); } }

async function ghGet(owner, repo, path, token){
  const url = `${API_BASE}/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const res = await fetch(url, { headers: { 'Authorization':'token ' + token, 'Accept':'application/vnd.github.v3+json' }});
  if(res.status === 404) return null;
  if(!res.ok) throw new Error('GitHub GET error: ' + res.status + ' - ' + await res.text());
  return await res.json();
}
async function ghPut(owner, repo, path, contentB64, message, sha, token, branch){
  const url = `${API_BASE}/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: contentB64, branch };
  if(sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers: { 'Authorization':'token ' + token, 'Accept':'application/vnd.github.v3+json', 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  if(!res.ok) throw new Error('GitHub PUT error: ' + res.status + ' - ' + await res.text());
  return await res.json();
}

function genId(){ return 'id_' + Math.random().toString(36).slice(2,10); }

document.getElementById('form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const st = document.getElementById('status');
  st.textContent = 'Memproses...';
  try{
    const name = (document.getElementById('name').value||'').trim();
    const email = (document.getElementById('email').value||'').trim().toLowerCase();
    const wa = (document.getElementById('wa').value||'').trim();
    const dob = (document.getElementById('dob').value||'').trim();
    const code = (document.getElementById('code').value||'').trim();

    if(!name || !email || !wa || !dob || !code) { st.textContent = 'Isi semua field.'; return; }

    // 1) GET DB file
    const file = await ghGet(DB_OWNER, DB_REPO, DB_PATH, DB_TOKEN);
    let db = { codes: [], accounts: [] };
    let sha = null;
    if(file){
      sha = file.sha;
      const content = b64dec(file.content.replace(/\n/g,''));
      db = JSON.parse(content);
    }

    db.codes = db.codes || [];
    db.accounts = db.accounts || [];

    // 2) find code unused
    const found = db.codes.find(c => c.code === code && !c.used);
    if(!found){ st.textContent = 'Kode tidak valid atau sudah digunakan.'; return; }

    // 3) add account, mark code used
    const acc = { id: genId(), name, email, wa, dob, created_at: (new Date()).toISOString(), expires_at: null, servers: [] };
    db.accounts.push(acc);
    found.used = true;
    found.used_by = email;
    found.used_at = (new Date()).toISOString();

    // 4) write back to GitHub
    const newContent = b64enc(JSON.stringify(db, null, 2));
    await ghPut(DB_OWNER, DB_REPO, DB_PATH, newContent, `Add account ${acc.id} via login`, sha, DB_TOKEN, DB_BRANCH);

    // 5) store session for create.html: store auth user and db config/token
    sessionStorage.setItem('auth_logged_in','1');
    sessionStorage.setItem('auth_user', JSON.stringify(acc));
    sessionStorage.setItem('db_cfg', JSON.stringify({ owner:DB_OWNER, repo:DB_REPO, path:DB_PATH, branch:DB_BRANCH, token:DB_TOKEN }));

    st.textContent = 'Login sukses — mengarahkan ke create panel...';
    setTimeout(()=> window.location.href = 'create.html', 700);

  }catch(err){
    st.textContent = 'Error: ' + (err.message || err);
    console.error(err);
  }
});
</script>
</body>
</html>