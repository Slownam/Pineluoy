<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Login — Panel</title>
<style>
:root{--bg1:#120633;--bg2:#0b3b6f;--card:rgba(255,255,255,0.03);--accent:#7c3aed;--text:#eaf2ff}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{width:100%;max-width:520px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(1,6,30,0.6)}
h2{margin:0 0 6px 0}
label{display:block;margin-top:10px;font-size:13px;color:#cfe0ff}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);margin-top:8px}
.btn{width:100%;margin-top:14px;padding:12px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#4f46e5);color:white;font-weight:700;cursor:pointer}
.steps{margin-top:12px}
.step{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:700}
.spinner{width:16px;height:16px;border-radius:50%;border:3px solid rgba(255,255,255,0.12);border-top-color:white;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.err{color:#ffb4b4;margin-top:10px}
.small{font-size:13px;color:#cfe0ff;margin-top:10px}
.links{margin-top:12px;display:flex;gap:8px;align-items:center}
.link{color:#cfe0ff;text-decoration:underline}
</style>
</head>
<body>
  <div class="card">
    <h2>Login / Register</h2>
    <div class="small">Isi data & kode akses. Kode 1x pakai.</div>

    <form id="form">
      <label>Nama</label>
      <input id="name" class="input" placeholder="nama lengkap" required>

      <label>Email</label>
      <input id="email" class="input" placeholder="nama@gmail.com" type="email" required>

      <label>Nomor WA (628...)</label>
      <input id="wa" class="input" placeholder="6285..." required>

      <label>Tanggal Lahir (YYYY-MM-DD)</label>
      <input id="dob" class="input" placeholder="1990-01-01" required>

      <label>Kode Akses</label>
      <input id="code" class="input" placeholder="lfxxxxx" required>

      <button id="btnLogin" class="btn" type="submit">Login</button>
    </form>

    <div id="steps" class="steps"></div>
    <div id="err" class="err"></div>

    <div class="links">
      <div class="small">Butuh bantuan?</div>
      <a class="link" href="https://wa.me/6283150061244" target="_blank">WA</a>
      <a class="link" href="https://t.me/lfstarstore" target="_blank">Telegram</a>
    </div>
  </div>

<script src="settings.js"></script>
<script>
function getApiBase(){
  try{ const c = JSON.parse(localStorage.getItem('panel_api_cfg')||'null'); if(c && c.api_base) return c.api_base; }catch(e){}
  return (window.API_CONFIG && window.API_CONFIG.API_BASE) ? window.API_CONFIG.API_BASE : 'http://152.42.204.241:3000';
}
function showStep(text, busy=true){
  const el = document.getElementById('steps');
  el.innerHTML = `<div class="step">${busy?'<span class="spinner" aria-hidden="true"></span>':''}<div>${text}</div></div>`;
}
function clearStep(){ document.getElementById('steps').innerHTML = ''; }
function showErr(msg){ const e=document.getElementById('err'); e.textContent = msg; setTimeout(()=>e.textContent='',8000); }

async function apiRegister(data){
  const base = getApiBase();
  const res = await fetch(base + '/api/register', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(data)
  });
  let j;
  try{ j = await res.json(); } catch(e){ throw new Error('Server tidak merespon JSON'); }
  if(!j.ok) throw new Error(j.error || JSON.stringify(j));
  return j.account;
}

document.getElementById('form').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  document.getElementById('err').textContent = '';
  try{
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const wa = document.getElementById('wa').value.trim();
    const dob = document.getElementById('dob').value.trim();
    const code = document.getElementById('code').value.trim();

    if(!name||!email||!wa||!dob||!code) return showErr('Lengkapi semua field');

    showStep('Mengecek ketersediaan kode...');
    await new Promise(r=>setTimeout(r,300));

    showStep('Kode ditemukan — Menggunakan kode...');
    const account = await apiRegister({ name, email, wa, dob, code });

    showStep('Sukses, Anda Akan Di Alihkan Ke Halaman Lain', false);
    // simpan session
    sessionStorage.setItem('auth_user', JSON.stringify(account));
    // simpan api base juga agar create page tahu
    sessionStorage.setItem('panel_api_cfg', JSON.stringify({ api_base: getApiBase() }));
    setTimeout(()=> location.href = 'panel.html', 900);
  }catch(err){
    showStep('Gagal', false);
    showErr(err.message || 'Terjadi kesalahan');
    console.error(err);
  }
});
</script>
</body>
</html>