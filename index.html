<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Create Server Panel</title>
  <style>
    :root{--bg1:#6c5ce7;--bg2:#4f46e5;--accent:#8b5cf6}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#eef2ff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:100%;max-width:720px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:14px;padding:22px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(2,6,23,0.35)}
    h1{margin:0 0 8px;font-size:20px}
    p.lead{margin:0 0 16px;color:rgba(226,232,255,0.9)}
    label{display:block;font-weight:700;margin-top:10px;font-size:13px;color:#eef2ff}
    input,select{width:100%;padding:12px 14px;margin-top:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef8;outline:none;font-size:14px}
    .actions{display:flex;gap:12px;align-items:center;margin-top:14px}
    .btn{background:linear-gradient(90deg,#8b5cf6,#5b21b6);color:white;padding:10px 14px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .muted{color:rgba(226,232,255,0.8);font-size:13px}
    .result{margin-top:18px;padding:14px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03)}
    .loader{width:36px;height:36px;border-radius:50%;border:4px solid rgba(255,255,255,0.12);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .acct{display:flex;flex-direction:column;gap:8px}
    .field{display:flex;justify-content:space-between;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
    .label{color:#c7d2fe;font-weight:700}
    .value{color:#e6eef8}
    a.admin{color:#c7d2fe;text-decoration:underline}
    @media (max-width:560px){.actions{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Create Server</h1>
      <p class="lead">Masukkan nama server & pilih paket RAM.</p>

      <form id="form">
        <label for="name">Nama (username / nameserver)</label>
        <input id="name" name="name" placeholder="contoh: lfstar" required autocomplete="off" />

        <label for="package">Pilih Paket RAM</label>
        <select id="package" name="package">
          <option value="1gb">1GB</option>
          <option value="2gb">2GB</option>
          <option value="3gb">3GB</option>
          <option value="4gb">4GB</option>
          <option value="5gb">5GB</option>
          <option value="6gb">6GB</option>
          <option value="7gb">7GB</option>
          <option value="8gb">8GB</option>
          <option value="9gb">9GB</option>
          <option value="10gb">10GB</option>
          <option value="unlimited">Unlimited</option>
          <option value="unli">Unli</option>
        </select>

        <div class="actions">
          <button id="btn" class="btn" type="submit">Buat Server</button>
          <div id="statusArea" class="muted">&nbsp;</div>
        </div>
      </form>

      <div id="resultBox" class="result" style="display:none">
        <div id="loading" style="display:none;align-items:center;gap:12px;margin-bottom:12px"><div class="loader"></div><div class="muted">Sedang memproses... tunggu sebentar</div></div>

        <div id="localCreds" style="display:none;margin-bottom:12px"></div>

        <div id="prettyResult" style="display:none">
          <div class="acct" id="acctBox"></div>
        </div>

        <pre id="apiRaw" style="display:none;color:#e6eef8;white-space:pre-wrap"></pre>
      </div>

      <div style="margin-top:12px" class="muted">Admin: buka <a href="admin.html" class="admin">halaman admin</a> untuk ubah konfigurasi</div>
    </div>
  </div>

<script src="settings.js"></script>
<script>
  const VS_BASE = 'https://apiz.vsunsee.sbs/vsunseeV8/create';

  function getConfig(){
    const keys = ['Domain','ptla','ptlc','egg','nestid','loc','rootadmin'];
    const out = {};
    keys.forEach(k=>{
      const ls = localStorage.getItem('cfg_'+k);
      if(ls !== null) out[k]=ls;
      else if(window[k] !== undefined) out[k]=window[k];
      else out[k]='';
    });
    out.Domain = String(out.Domain||'').replace(/\/$/,'');
    out.rootadmin = out.rootadmin === 'true' || out.rootadmin === true;
    return out;
  }

  const resourceMap = {
    "1gb":  { ram: 1000,  disk: 1000,  cpu: 40 },
    "2gb":  { ram: 2000,  disk: 1000,  cpu: 60 },
    "3gb":  { ram: 3000,  disk: 2000,  cpu: 80 },
    "4gb":  { ram: 4000,  disk: 2000,  cpu: 100 },
    "5gb":  { ram: 5000,  disk: 3000,  cpu: 120 },
    "6gb":  { ram: 6000,  disk: 3000,  cpu: 140 },
    "7gb":  { ram: 7000,  disk: 4000,  cpu: 160 },
    "8gb":  { ram: 8000,  disk: 4000,  cpu: 180 },
    "9gb":  { ram: 9000,  disk: 5000,  cpu: 200 },
    "10gb": { ram:10000,  disk: 5000,  cpu: 220 },
    "unlimited": { ram: 0, disk: 0, cpu: 0 },
    "unli":      { ram: 0, disk: 0, cpu: 0 }
  };

  function rand3(){ return String(Math.floor(Math.random()*900)+100); }
  function sanitize(u){ return u.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_\.]/g,''); }

  const form = document.getElementById('form');
  const btn = document.getElementById('btn');
  const statusArea = document.getElementById('statusArea');
  const resultBox = document.getElementById('resultBox');
  const loading = document.getElementById('loading');
  const localCreds = document.getElementById('localCreds');
  const acctBox = document.getElementById('acctBox');
  const prettyResult = document.getElementById('prettyResult');
  const apiRaw = document.getElementById('apiRaw');

  function incrCounter(){
    const key = 'create_count_web';
    const cur = parseInt(localStorage.getItem(key)||'0',10);
    localStorage.setItem(key,String(cur+1));
  }

  function formatAccount(obj){
    const rows=[];
    const push=(l,v)=>rows.push(`<div class="field"><div class="label">${l}</div><div class="value">${v}</div></div>`);
    if(obj.data && typeof obj.data === 'object') obj = obj.data;
    if(obj.username) push('Username', obj.username);
    if(obj.password) push('Password', obj.password);
    if(obj.id_server || obj.id) push('Server ID', obj.id_server || obj.id);
    if(obj.nama_server || obj.name) push('Server Name', obj.nama_server || obj.name);
    if(obj.domain_panel) push('Domain:', obj.domain_panel);
    if(obj.root_admin !== undefined) push('Admin Panel', String(obj.root_admin));
    if(obj.creator) push('Creator', obj.creator);
    if(obj.tanggal || obj.created_at) push('Created', obj.tanggal || obj.created_at);
    if(rows.length===0) return '<pre>'+JSON.stringify(obj,null,2)+'</pre>';
    return rows.join('');
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const cfg = getConfig();
    if(!cfg.Domain){ alert('settings belum diisi (Domain). Buka admin jika perlu.'); return; }
    if(!cfg.ptla){ alert('settings belum diisi (ptla). Buka admin jika perlu.'); return; }

    const raw = document.getElementById('name').value || '';
    if(!raw.trim()){ alert('Isi nama dulu'); return; }
    const pkg = document.getElementById('package').value || '1gb';
    const map = resourceMap[pkg] || resourceMap['unlimited'];

    const username = sanitize(raw);
    const email = username + '@gmail.com';
    const password = username + rand3();
    const nameserver = username;

    resultBox.style.display = 'block';
    loading.style.display = 'flex';
    prettyResult.style.display = 'none';
    apiRaw.style.display = 'none';
    localCreds.style.display = 'block';
    localCreds.innerHTML = `<div class="field"><div class="label">Email</div><div class="value">${email}</div></div><div class="field"><div class="label">Password</div><div class="value">${password}</div></div>`;

    btn.disabled = true; statusArea.textContent = 'Mengirim...';

    try{
      const params = new URLSearchParams({
        domain: cfg.Domain,
        apikeyptero: cfg.ptla,
        capikeyptero: cfg.ptlc,
        nameserver: nameserver,
        password: password,
        disk: String(map.disk),
        cpu: String(map.cpu),
        rootadmin: String(cfg.rootadmin)
      });
      const url = VS_BASE + '?' + params.toString();
      const res = await fetch(url, { method:'GET', headers:{ 'Accept':'application/json' }});
      const text = await res.text();

      let parsed = null;
      try{ parsed = JSON.parse(text); }catch(e){ parsed = null; }

      loading.style.display = 'none';
      localCreds.style.display = 'none';

      if(parsed){
        acctBox.innerHTML = formatAccount(parsed);
        prettyResult.style.display = 'block';
        apiRaw.style.display = 'none';
        if(parsed.status === true || parsed.success === true || parsed.data) incrCounter();
      } else {
        apiRaw.textContent = text;
        apiRaw.style.display = 'block';
      }

      statusArea.textContent = res.ok ? 'Selesai' : `Selesai (HTTP ${res.status})`;
    } catch(err){
      loading.style.display = 'none';
      apiRaw.textContent = 'Request error: ' + err.message;
      apiRaw.style.display = 'block';
      statusArea.textContent = 'Gagal';
    } finally{
      btn.disabled = false;
    }
  });
</script>
</body>
</html>