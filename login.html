<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login — Panel</title>
  <style>
    :root{--bg1:#6c5ce7;--bg2:#4f46e5}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#eef2ff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:100%;max-width:480px;background:rgba(255,255,255,0.04);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.06)}
    label{display:block;margin-top:10px;font-weight:700;font-size:13px}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6eef8;margin-top:8px}
    .btn{margin-top:14px;width:100%;padding:12px;border-radius:10px;border:0;background:linear-gradient(90deg,#8b5cf6,#5b21b6);color:white;font-weight:700;cursor:pointer}
    .muted{color:rgba(226,232,255,0.85);font-size:13px;margin-top:8px}
    .error{color:#ffb4b4;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Login</h2>
      <p class="muted">Masukkan Email dan nomor WA yang terdaftar. Jika valid akan diarahkan ke halaman Create Panel.</p>

      <form id="loginForm">
        <label for="email">Email</label>
        <input id="email" type="email" required placeholder="nama@gmail.com" />

        <label for="wa">Nomor WA (contoh: 6285...)</label>
        <input id="wa" required placeholder="6285..." />

        <button id="btn" class="btn" type="submit">Login</button>
      </form>

      <div id="status" class="muted"></div>
      <div id="err" class="error" style="display:none"></div>
      <p style="margin-top:12px" class="muted">Admin? buka <a href="admin.html" style="color:#c7d2fe">Admin Panel</a></p>
    </div>
  </div>

<script src="settings.js"></script>
<script>
/*
  Login flow:
  - baca config GitHub dari localStorage override (cfg_GITHUB_*) atau settings.js window.*
  - GET database.json dari GitHub
  - cari account dengan matching email (case-insensitive) & wa (exact)
  - jika ketemu -> simpan sessionStorage auth_user dan redirect ke create.html
*/

const GITHUB_API_BASE = 'https://api.github.com/repos';

function getCfg(){
  const keys = ['GITHUB_OWNER','GITHUB_REPO','GITHUB_PATH','GITHUB_BRANCH','GITHUB_TOKEN'];
  const out = {};
  keys.forEach(k=>{
    const v = localStorage.getItem('cfg_'+k);
    if(v !== null) out[k] = v; else out[k] = window[k] || '';
  });
  if(!out.GITHUB_PATH) out.GITHUB_PATH = window.GITHUB_PATH || 'database.json';
  if(!out.GITHUB_BRANCH) out.GITHUB_BRANCH = window.GITHUB_BRANCH || 'main';
  return out;
}

async function ghGet(owner, repo, path, token){
  const url = `${GITHUB_API_BASE}/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  const res = await fetch(url, { headers: { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json' }});
  if(res.status === 404) return null;
  if(!res.ok) throw new Error('GitHub GET error: ' + res.status + ' ' + await res.text());
  return await res.json();
}

function safeB64Decode(b64){
  try { return decodeURIComponent(escape(atob(b64))); } catch(e) { return atob(b64); }
}

function cleanExpired(db){
  const now = Date.now();
  db.accounts = (db.accounts||[]).filter(a=>{
    if(!a.expires_at) return true;
    const t = Date.parse(a.expires_at);
    return isNaN(t) ? true : t > now;
  });
  return db;
}

const form = document.getElementById('loginForm');
const statusEl = document.getElementById('status');
const errEl = document.getElementById('err');

form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  errEl.style.display = 'none';
  statusEl.textContent = 'Memeriksa akun...';
  const email = (document.getElementById('email').value||'').trim().toLowerCase();
  const wa = (document.getElementById('wa').value||'').trim();

  const cfg = getCfg();
  if(!cfg.GITHUB_OWNER || !cfg.GITHUB_REPO || !cfg.GITHUB_TOKEN){
    errEl.textContent = 'GitHub config belum diisi (owner/repo/token). Silakan isi di Admin Panel.'; errEl.style.display='block'; statusEl.textContent=''; return;
  }

  try{
    const file = await ghGet(cfg.GITHUB_OWNER, cfg.GITHUB_REPO, cfg.GITHUB_PATH, cfg.GITHUB_TOKEN);
    let db = { accounts: [], codes: [] };
    if(file){
      const content = safeB64Decode(file.content.replace(/\n/g,''));
      db = JSON.parse(content);
    }
    db = cleanExpired(db);

    const found = (db.accounts||[]).find(a => (a.email||'').toLowerCase() === email && (a.wa||'') === wa);
    if(!found){
      errEl.textContent = 'Akun tidak ditemukan atau data salah.'; errEl.style.display='block'; statusEl.textContent=''; return;
    }

    // save session and redirect
    sessionStorage.setItem('auth_user', JSON.stringify(found));
    sessionStorage.setItem('auth_logged_in', '1');
    statusEl.textContent = 'Login sukses — mengarahkan ke create panel...';
    setTimeout(()=> window.location.href = 'create.html', 600);

  }catch(err){
    errEl.textContent = 'Error: ' + (err.message || err); errEl.style.display='block';
  } finally {
    // clear status after a short delay (if not redirected)
    setTimeout(()=> statusEl.textContent = '', 1000);
  }
});
</script>
</body>
</html>